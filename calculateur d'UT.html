<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculateur de Charge de Test Multi-Catégories</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            background-color: #f4f4f4;
            display: flex; /* Use flexbox for body to push footer down */
            flex-direction: column; /* Stack children vertically */
            min-height: 100vh; /* Make body at least viewport height */
        }

        #calculator-container {
            max-width: 950px;
            margin: 20px auto;
            background-color: #fff;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            flex-grow: 1; /* Allow container to grow and push footer down */
        }

        h1, h2 {
            color: #333;
        }

        .checkbox-group {
             margin-bottom: 15px;
             padding: 10px;
             border: 1px dashed #ccc;
             border-radius: 5px;
             background-color: #fcfcfc;
             display: flex;
             flex-wrap: wrap;
             gap: 15px;
        }
         .checkbox-group > div {
             display: flex;
             align-items: center;
         }

         .checkbox-group label {
             font-weight: bold;
             width: auto;
             margin-right: 0;
             margin-left: 5px;
             cursor: pointer;
             color: #0056b3;
         }
         .checkbox-group input[type="checkbox"] {
              vertical-align: middle;
              margin-top: 0;
              margin-bottom: 0;
              padding: 0;
              width: auto;
         }


        label {
            display: inline-block;
            margin-bottom: 5px;
            font-weight: bold;
            width: 250px;
            vertical-align: top;
        }
        select, input[type="number"] {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100px;
            display: inline-block;
            vertical-align: top;
        }
         input[type="number"] {
             width: 80px;
         }

        .category-input-group {
            margin-bottom: 8px;
        }
         .category-input-group label,
         .category-input-group input {
             margin-bottom: 0;
         }

        /* Fieldset for grouping categories by R code */
        fieldset {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px 20px;
            margin: 10px 0;
            background-color: #f9f9f9;
        }
        legend {
            font-size: 1.1em;
            font-weight: bold;
            padding: 0 10px;
            color: #0056b3;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
         fieldset.placeholder {
             background-color: #fff3cd;
             border-color: #ffecb3;
             color: #856404;
         }
          fieldset.placeholder legend {
              background-color: #ffe08a;
              border-color: #ffcc80;
              color: #856404;
          }


        /* Button Container for side-by-side layout */
        .button-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 20px;
        }

        .calculator-buttons {
            display: flex;
            gap: 15px;
        }


        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        button#calculateButton {
            background-color: #28a745;
            color: white;
        }
        button#calculateButton:hover {
            background-color: #218838;
        }
         button#calculateButton:active {
             background-color: #1e7e34;
         }

         button#clearButton {
            background-color: #ffcdd2;
            color: #d32f2f;
            border: 1px solid #ef9a9a;
        }
         button#clearButton:hover {
             background-color: #ef9a9a;
             color: #b71c1c;
             border-color: #ef9a9a;
         }
          button#clearButton:active {
             background-color: #e57373;
             border-color: #e57373;
          }

        /* Style for the PayPal form within the button container */
        .button-container form {
             margin: 0;
             padding: 0;
             line-height: 0;
        }


        #results {
            margin-top: 30px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .result-line {
            margin-bottom: 8px;
        }
        .warning {
            color: orange;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .success {
             color: green;
             font-weight: bold;
        }
         .info {
             color: #0056b3;
         }
         .hidden {
             display: none;
         }
        table {
            margin-top: 20px;
            border-collapse: collapse;
            width: 100%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-size: 0.9em;
        }
         /* Style specifically for the assignment table */
        #assignmentResults table {
            width: 98%;
            margin: 20px auto;
            border: 1px solid #ddd;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px 4px;
            text-align: right;
        }
         td:first-child {
             text-align: left;
             font-weight: normal;
             color: #333;
              white-space: normal;
         }
        th {
            background-color: #e9ecef;
            color: #495057;
            font-weight: bold;
            text-align: center;
            white-space: nowrap;
        }
         td {
              white-space: nowrap;
         }


        tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        tbody tr:hover {
            background-color: #e2e6ea;
        }

         caption {
             caption-side: top;
             text-align: left;
             font-size: 1.1em;
             font-weight: bold;
             margin-bottom: 10px;
             color: #333;
         }

         /* Footer styles */
        footer {
            background-color: #e9ecef;
            padding: 15px;
            text-align: center;
            border-top: 1px solid #dee2e6;
            margin-top: 30px; /* Add some space above the footer */
            color: #6c757d;
            font-size: 0.9em;
             /* Prevent footer from shrinking */
            flex-shrink: 0;
        }
    </style>
</head>
<body>

    <div id="calculator-container">

        <h1>Calculateur de Charge de Test</h1>

        <form id="calculatorForm">
            <div>
                <label for="numTestersSelect">Nombre de testeurs attribués :</label>
                <select id="numTestersSelect">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    </select>
            </div>

            <h2>Codes de Catégories à Inclure :</h2>
            <div class="checkbox-group">
                 <div>
                    <input type="checkbox" id="r482Checkbox" onchange="handleRCodeToggle('r482')">
                    <label for="r482Checkbox">R482</label>
                 </div>
                 <div>
                     <input type="checkbox" id="r484Checkbox" onchange="handleRCodeToggle('r484')">
                    <label for="r484Checkbox">R484</label>
                 </div>
                 <div>
                     <input type="checkbox" id="r485Checkbox" onchange="handleRCodeToggle('r485')">
                     <label for="r485Checkbox">R485</label>
                 </div>
                 <div>
                    <input type="checkbox" id="r486Checkbox" onchange="handleRCodeToggle('r486')">
                    <label for="r486Checkbox">R486</label>
                 </div>
                  <div>
                    <input type="checkbox" id="r489Checkbox" onchange="handleRCodeToggle('r489')">
                    <label for="r489Checkbox">R489</label>
                 </div>
                  <div>
                     <input type="checkbox" id="r490Checkbox" onchange="handleRCodeToggle('r490')">
                     <label for="r490Checkbox">R490</label>
                 </div>
            </div>


             <fieldset id="r482Categories" class="hidden placeholder">
                 <legend>Catégories R482</legend>
                 <p>Veuillez définir les catégories et leurs valeurs UT pour R482 afin de les inclure dans le calcul. Les documents de recommandation définissent les UT pour les évaluations testeurs, pas pour les tâches opérationnelles.</p>
             </fieldset>

            <fieldset id="r484Categories" class="hidden">
                <legend>Catégories R484 (Ponts Roulants & Portiques)</legend>

                <div id="r484_cat1_group" class="category-input-group">
                    <label for="r484_cat1">Catégorie 1 (Commande au sol - 1 UT/unité) :</label>
                    <input type="number" id="r484_cat1" min="0" value="0" required>
                </div>
                <div id="r484_cat2_group" class="category-input-group">
                    <label for="r484_cat2">Catégorie 2 (Commande en cabine - 0.75 UT/unité) :</label>
                    <input type="number" id="r484_cat2" min="0" value="0" required>
                </div>

            </fieldset>

             <fieldset id="r485Categories" class="hidden">
                <legend>Catégories R485 (Gerbeurs à conducteur accompagnant)</legend>

                <div id="r485_cat1_group" class="category-input-group">
                    <label for="r485_cat1">Catégorie 1 (1,20m à 2,5m - 0.75 UT/unité) :</label>
                    <input type="number" id="r485_cat1" min="0" value="0" required>
                </div>
                <div id="r485_cat2_group" class="category-input-group">
                    <label for="r485_cat2">Catégorie 2 (> 2,5m - 0.75 UT/unité) :</label>
                    <input type="number" id="r485_cat2" min="0" value="0" required>
                </div>

            </fieldset>

             <fieldset id="r486Categories" class="hidden">
                <legend>Catégories R486 (PEMP)</legend>

                <div id="r486_catA_group" class="category-input-group">
                    <label for="r486_catA">Catégorie A (Verticale - 1 UT/unité) :</label>
                    <input type="number" id="r486_catA" min="0" value="0" required>
                </div>
                <div id="r486_catB_group" class="category-input-group">
                    <label for="r486_catB">Catégorie B (Multidirectionnelle - 1 UT/unité) :</label>
                    <input type="number" id="r486_catB" min="0" value="0" required>
                </div>
                 </fieldset>

             <fieldset id="r489Categories" class="hidden">
                <legend>Catégories R489 (Chariots à conducteur porté)</legend>

                 <div>
                    <label for="numCategoryTypesSelect">Nombre de types de catégories R489 à inclure :</label>
                    <select id="numCategoryTypesSelect" onchange="toggleR489CategoryInputs()">
                        <option value="3">3 types (Cat 3/4, 5/1b, 1a)</option>
                        <option value="2">2 types (Cat 3/4, 5/1b)</option>
                        <option value="1">1 type (Cat 3/4)</option>
                    </select>
                </div>

                <div id="r489_cat3_4_group" class="category-input-group">
                    <label for="r489_cat3_4">Catégorie 3 et 4 (1 UT/unité) :</label>
                    <input type="number" id="r489_cat3_4" min="0" value="0" required>
                </div>
                <div id="r489_cat5_1b_group" class="category-input-group">
                    <label for="r489_cat5_1b">Catégorie 5 et 1b (0.75 UT/unité) :</label>
                    <input type="number" id="r489_cat5_1b" min="0" value="0" required>
                </div>
                <div id="r489_cat1a_group" class="category-input-group">
                    <label for="r489_cat1a">Catégorie 1a (0.50 UT/unité) :</label>
                    <input type="number" id="r489_cat1a" min="0" value="0" required>
                </div>

            </fieldset>

             <fieldset id="r490Categories" class="hidden">
                 <legend>Catégorie R490 (Grues de chargement)</legend>
                  <div id="r490_units_group" class="category-input-group">
                     <label for="r490_units">Unités (1.75 UT/unité) :</label>
                     <input type="number" id="r490_units" min="0" value="0" required>
                 </div>
             </fieldset>


            <div class="button-container">
                <div class="calculator-buttons">
                    <button type="button" id="calculateButton" onclick="calculateLoad()">Calculer la charge</button>
                    <button type="button" id="clearButton" onclick="clearForm()">Vider</button>
                </div>

                <form action="https://www.paypal.com/donate" method="post" target="_top">
                    <input type="hidden" name="hosted_button_id" value="PLTPDAX77WBLJ" />
                    <input type="image" src="https://www.paypalobjects.com/fr_FR/FR/i/btn/btn_donate_LG.gif" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Bouton Faites un don avec PayPal" />
                    <img alt="" border="0" src="https://www.paypal.com/fr_FR/i/scr/pixel.gif" width="1" height="1" />
                </form>
            </div>

        </form>

        <div id="results">
            </div>

         <div id="assignmentResults">
            </div>

    </div> <footer>
        <p>&copy; 2025 TLM CF - Tous droits réservés</p>
    </footer>


    <script>

        let isCalculating = false; // Flag to prevent multiple executions

        // Define UT values for all potential categories based on user input/previous versions
        const utValues = {
            r489_cat3_4: 1,
            r489_cat5_1b: 0.75,
            r489_cat1a: 0.50,
            r485_cat1: 0.75,
            r485_cat2: 0.75,
            r484_cat1: 1,
            r484_cat2: 0.75,
            r486_catA: 1,
            r486_catB: 1,
            r490_units: 1.75
             // R482 still needs UT values per unit if applicable
        };

        const maxUtPerTesterPerDay = 6;

         // List of all R codes in the desired numerical order
        const rCodes = ['r482', 'r484', 'r485', 'r486', 'r489', 'r490'];


         // List of R codes that are placeholders (no categories defined for task-based UT calculation)
         const placeholderRCodes = ['r482'];


        // List of all R codes and their category input IDs
        const rCodeCategoryInputs = {
            r489: ['r489_cat3_4', 'r489_cat5_1b', 'r489_cat1a'],
            r485: ['r485_cat1', 'r485_cat2'],
            r484: ['r484_cat1', 'r484_cat2'],
            r486: ['r486_catA', 'r486_catB'],
            r490: ['r490_units'],
            r482: [] // No categories defined for task-based UTs
        };


        // Function to show/hide a specific R Code categories fieldset
        function handleRCodeToggle(rCode) {
            const checkbox = document.getElementById(`${rCode}Checkbox`);
            const fieldset = document.getElementById(`${rCode}Categories`);

            if (!checkbox || !fieldset) return;


            if (checkbox.checked) {
                fieldset.classList.remove('hidden');
                // For R489, also trigger the sub-category toggle based on its select
                if (rCode === 'r489') {
                     toggleR489CategoryInputs();
                }
                // Add logic here if other R codes have similar sub-toggles

            } else {
                fieldset.classList.add('hidden');
                // When hiding, reset all contained inputs to 0
                const inputs = fieldset.querySelectorAll('input[type="number"]');
                inputs.forEach(input => input.value = 0);

            }
             // Clear results whenever any R code section is toggled, as the input data changes
            document.getElementById('results').innerHTML = '';
            document.getElementById('assignmentResults').innerHTML = '';
        }


        // Function to show/hide the specific category input groups within R489 fieldset
        function toggleR489CategoryInputs() {
             // Only operate if the R489 fieldset is currently visible
             const r489Fieldset = document.getElementById('r489Categories');
             if (r489Fieldset.classList.contains('hidden')) {
                 // If R489 is hidden, the categories are also hidden, do nothing here
                 return;
             }

            const numTypes = parseInt(document.getElementById('numCategoryTypesSelect').value);
            document.getElementById('r489_cat3_4_group').classList.add('hidden');
            document.getElementById('r489_cat5_1b_group').classList.add('hidden');
            document.getElementById('r489_cat1a_group').classList.add('hidden');

            if (numTypes >= 1) {
                document.getElementById('r489_cat3_4_group').classList.remove('hidden');
            }
            if (numTypes >= 2) {
                document.getElementById('r489_cat5_1b_group').classList.remove('hidden');
            }
            if (numTypes >= 3) {
                document.getElementById('r489_cat1a_group').classList.remove('hidden');
            }

             // Reset values of hidden inputs to 0 to avoid calculating them
             if (numTypes < 3) {
                 const input = document.getElementById('r489_cat1a');
                 if(input) input.value = 0;
             }
             if (numTypes < 2) {
                 const input = document.getElementById('r489_cat5_1b');
                  if(input) input.value = 0;
             }


             // Clear results when the inputs visibility changes
             document.getElementById('results').innerHTML = '';
             document.getElementById('assignmentResults').innerHTML = '';
        }

        // Function to clear the form and results
        function clearForm() {
             const numTestersSelect = document.getElementById('numTestersSelect');
             if (numTestersSelect) numTestersSelect.value = '1';


             rCodes.forEach(rCode => {
                  const checkbox = document.getElementById(`${rCode}Checkbox`);
                  if (checkbox) {
                      checkbox.checked = false;
                      handleRCodeToggle(rCode);
                  }
             });


             const numCategoryTypesSelect = document.getElementById('numCategoryTypesSelect');
             if (numCategoryTypesSelect) {
                 numCategoryTypesSelect.value = '3';
             }


             document.getElementById('results').innerHTML = '';
             document.getElementById('assignmentResults').innerHTML = '';
        }


        function calculateLoad() {
            if (isCalculating) {
                console.log("Calculation already in progress, returning.");
                return; // Exit if already running
            }
            isCalculating = true; // Set flag at the start


            const numTesters = parseInt(document.getElementById('numTestersSelect').value);

            const quantities = {};


            let totalUtRequired = 0;
            const includedCategories = [];


            for (const rCode of rCodes) {
                 if (placeholderRCodes.includes(rCode)) {
                     // Checkbox is checked, but it's a placeholder without categories for calculation
                      const checkbox = document.getElementById(`${rCode}Checkbox`);
                      if (checkbox && checkbox.checked) {
                           document.getElementById('results').innerHTML = `<p class="warning">Attention : Le code R${rCode.replace('r', '').toUpperCase()} est sélectionné mais n\'a pas de catégories définies pour le calcul de charge. Veuillez définir les catégories et UT pour l\'inclure dans le calcul.</p>`;
                            document.getElementById('assignmentResults').innerHTML = '';
                            isCalculating = false; return;
                      }
                     continue; // Skip processing for placeholders
                 }

                const checkbox = document.getElementById(`${rCode}Checkbox`);
                if (checkbox && checkbox.checked) {
                    const fieldset = document.getElementById(`${rCode}Categories`);
                     if (fieldset) {

                         if (rCode === 'r489') {
                             const numTypesSelectedR489 = parseInt(document.getElementById('numCategoryTypesSelect').value);
                              if (numTypesSelectedR489 >= 1) {
                                 const catId = 'r489_cat3_4';
                                 const inputElement = document.getElementById(catId);
                                 if (inputElement && !isNaN(parseInt(inputElement.value)) && parseInt(inputElement.value) >= 0) {
                                    quantities[catId] = parseInt(inputElement.value);
                                    totalUtRequired += quantities[catId] * utValues[catId];
                                    includedCategories.push(catId);
                                 } else {
                                     document.getElementById('results').innerHTML = `<p class="error">Veuillez entrer une valeur numérique valide (>= 0) pour ${document.querySelector('label[for="' + catId + '"]').textContent}.</p>`;
                                     document.getElementById('assignmentResults').innerHTML = '';
                                     isCalculating = false; return; // Reset flag and stop
                                 }
                              }
                               if (numTypesSelectedR489 >= 2) {
                                  const catId = 'r489_cat5_1b';
                                  const inputElement = document.getElementById(catId);
                                   if (inputElement && !isNaN(parseInt(inputElement.value)) && parseInt(inputElement.value) >= 0) {
                                      quantities[catId] = parseInt(inputElement.value);
                                      totalUtRequired += quantities[catId] * utValues[catId];
                                       includedCategories.push(catId);
                                  } else {
                                       document.getElementById('results').innerHTML = `<p class="error">Veuillez entrer une valeur numérique valide (>= 0) pour ${document.querySelector('label[for="' + catId + '"]').textContent}.</p>`;
                                       document.getElementById('assignmentResults').innerHTML = '';
                                       isCalculating = false; return; // Reset flag and stop
                                   }
                               }
                                if (numTypesSelectedR489 >= 3) {
                                  const catId = 'r489_cat1a';
                                  const inputElement = document.getElementById(catId);
                                   if (inputElement && !isNaN(parseInt(inputElement.value)) && parseInt(inputElement.value) >= 0) {
                                      quantities[catId] = parseInt(inputElement.value);
                                      totalUtRequired += quantities[catId] * utValues[catId];
                                       includedCategories.push(catId);
                                  } else {
                                        document.getElementById('results').innerHTML = `<p class="error">Veuillez entrer une valeur numérique valide (>= 0) pour ${document.querySelector('label[for="' + catId + '"]').textContent}.</p>`;
                                        document.getElementById('assignmentResults').innerHTML = '';
                                        isCalculating = false; return; // Reset flag and stop
                                    }
                                }
                         } else {
                             let currentRCodeError = false;
                             const categoriesForRCode = rCodeCategoryInputs[rCode];
                             if (categoriesForRCode && categoriesForRCode.length > 0) {
                                 categoriesForRCode.forEach(catId => {
                                    const inputElement = document.getElementById(catId);
                                     if (inputElement) {
                                         const quantity = parseInt(inputElement.value);
                                         if (!isNaN(quantity) && quantity >= 0) {
                                            quantities[catId] = quantity;
                                            totalUtRequired += quantities[catId] * utValues[catId];
                                            includedCategories.push(catId);
                                         } else {
                                             document.getElementById('results').innerHTML = `<p class="error">Veuillez entrer une valeur numérique valide (>= 0) pour ${document.querySelector('label[for="' + catId + '"]').textContent}.</p>`;
                                             document.getElementById('assignmentResults').innerHTML = '';
                                             currentRCodeError = true;
                                         }
                                     }
                                 });
                             }
                              if (currentRCodeError) { isCalculating = false; return; }
                         }
                     }
                }
            }


            const resultsDiv = document.getElementById('results');
            const assignmentResultsDiv = document.getElementById('assignmentResults');

             // Clear previous results before adding new ones
             resultsDiv.innerHTML = '';
             assignmentResultsDiv.innerHTML = '';


             if (totalUtRequired === 0 && includedCategories.length > 0) {
                 resultsDiv.innerHTML = '<p class="info">Les catégories sélectionnées ont 0 UT total requis. Veuillez vérifier les quantités.</p>';
                  assignmentResultsDiv.innerHTML = '<p class="info">Aucune unité de test à répartir.</p>';
                 isCalculating = false; return;
             }
             if (totalUtRequired === 0 && includedCategories.length === 0) {
                 resultsDiv.innerHTML = '<p class="info">Aucune catégorie de test n\'est sélectionnée.</p>';
                 assignmentResultsDiv.innerHTML = '<p class="info">Aucune unité de test à répartir.</p>';
                 isCalculating = false; return;
             }


            const maxTotalUtPossible = numTesters * maxUtPerTesterPerDay;

            resultsDiv.innerHTML += `<p class="result-line">Unités de test (UT) totales requises : <span class="success">${totalUtRequired.toFixed(2)} UT</span></p>`;
            resultsDiv.innerHTML += `<p class="result-line">Unités de test (UT) maximales réalisables par jour avec ${numTesters} testeur(s) : <span class="result-line">${maxTotalUtPossible.toFixed(2)} UT</span></p>`;

            const averageUtPerTester = totalUtRequired / numTesters;

            resultsDiv.innerHTML += `<h3>Répartition de la charge par testeur (Moyenne) :</h3>`;
            resultsDiv.innerHTML += `<p class="result-line info">Charge moyenne par testeur : <span>${averageUtPerTester.toFixed(2)} UT</span></p>`;


            const uniqueIncludedCategories = includedCategories;


            if (totalUtRequired <= maxTotalUtPossible) {
                 resultsDiv.innerHTML += `<p class="success">Cette tâche est réalisable en une journée avec ${numTesters} testeur(s).</p>`;
                 if (averageUtPerTester <= maxUtPerTesterPerDay + 1e-9) {
                      resultsDiv.innerHTML += `<p class="success">La charge moyenne par testeur (${averageUtPerTester.toFixed(2)} UT) respecte la limite individuelle de ${maxUtPerTesterPerDay} UT par jour.</p>`;
                 } else {
                        resultsDiv.innerHTML += `<p class="warning">Attention : Bien que la charge totale soit gérable, la charge moyenne par testeur (${averageUtPerTester.toFixed(2)} UT) semble dépasser la limite individuelle de ${maxUtPerTesterPerDay} UT. Vérifiez les valeurs.</p>`;
                 }


                assignmentResultsDiv.innerHTML += '<caption>Répartition Indicative des Unités par Testeur (pour une journée)</caption>';
                let tableHtml = '<table>';
                tableHtml += '<thead><tr><th>Testeur</th>';

                uniqueIncludedCategories.forEach(catId => {
                     let headerText = catId.replace('_', ' ').toUpperCase();
                     if (catId.startsWith('r489_')) headerText = 'R489 ' + headerText.replace('R489 ', '');
                     else if (catId.startsWith('r485_')) headerText = 'R485 ' + headerText.replace('R485 ', '');
                     else if (catId.startsWith('r484_')) headerText = 'R484 ' + headerText.replace('R484 ', '');
                     else if (catId.startsWith('r486_')) headerText = 'R486 ' + headerText.replace('R486 ', '');
                      else if (catId.startsWith('r490_')) headerText = 'R490 ' + headerText.replace('R490 ', '');


                    tableHtml += `<th>${headerText}</th>`;
                });

                tableHtml += '<th>Total UT (Journée)</th></tr></thead>';
                tableHtml += '<tbody>';

                const testerAssignments = [];
                for (let i = 0; i < numTesters; i++) {
                    const assignment = { totalUt: 0 };
                    uniqueIncludedCategories.forEach(catId => assignment[catId] = 0);
                    testerAssignments.push(assignment);
                }

                const remainingUnits = {};
                uniqueIncludedCategories.forEach(catId => remainingUnits[catId] = quantities[catId]);


                let unitsAssignedInPass;
                let currentTesterIndex = 0;
                const categoryOrder = [...uniqueIncludedCategories].sort((a, b) => utValues[b] - utValues[a]);


                do {
                    unitsAssignedInPass = 0;
                    for (let i = 0; i < numTesters; i++) {
                        const testerIndex = (currentTesterIndex + i) % numTesters;
                        const tester = testerAssignments[testerIndex];

                        for (const categoryId of categoryOrder) {

                            if (remainingUnits[categoryId] > 0) {
                                if (tester.totalUt + utValues[categoryId] <= maxUtPerTesterPerDay + 1e-9) {
                                    tester[categoryId]++;
                                    tester.totalUt += utValues[categoryId];
                                    remainingUnits[categoryId]--;
                                    unitsAssignedInPass++;
                                    break;
                                }
                            }
                        }
                    }
                     if (unitsAssignedInPass > 0) {
                        currentTesterIndex = (currentTesterIndex + 1) % numTesters;
                     } else {
                        break;
                     }

                } while (true);


                let totalRemainingUnits = 0;
                uniqueIncludedCategories.forEach(catId => totalRemainingUnits += remainingUnits[catId]);

                 if (Math.abs(totalRemainingUnits) > 1e-9) {
                      assignmentResultsDiv.innerHTML += `<p class="warning">Attention : ${totalRemainingUnits.toFixed(0)} unités n\'ont pas pu être attribuées par l\'algorithme dans la limite de 6 UT par jour par testeur. Des ajustements manuels pourraient être nécessaires.</p>`;
                 }


                let totalAssignedUt = 0;
                 const totalAssignedCategories = {};
                 uniqueIncludedCategories.forEach(catId => totalAssignedCategories[catId] = 0);


                for (let i = 0; i < numTesters; i++) {
                    const tester = testerAssignments[i];
                    tableHtml += '<tr>';
                    tableHtml += `<td>Testeur ${i + 1}</td>`;
                    uniqueIncludedCategories.forEach(catId => {
                        tableHtml += `<td>${tester[catId]}</td>`;
                        totalAssignedCategories[catId] += tester[catId];
                    });
                    tableHtml += `<td>${tester.totalUt.toFixed(2)}</td>`;
                    tableHtml += '</tr>';

                    totalAssignedUt += tester.totalUt;
                }

                tableHtml += '<tfoot><tr><td><strong>Total Attribué</strong></td>';
                uniqueIncludedCategories.forEach(catId => {
                     tableHtml += `<td><strong>${totalAssignedCategories[catId]}</strong></td>`;
                });
                 const finalTotalAssignedUt = testerAssignments.reduce((sum, tester) => sum + tester.totalUt, 0);
                 tableHtml += `<td><strong>${finalTotalAssignedUt.toFixed(2)}</strong></td></tr></tfoot>`;


                tableHtml += '</tbody>';
                tableHtml += '</table>';
                assignmentResultsDiv.innerHTML += tableHtml;
                assignmentResultsDiv.innerHTML += '<p class="info"><em>Cette répartition est une proposition basée sur l\'attribution séquentielle des unités en respectant la limite de 6 UT par testeur pour une journée. Elle peut ne pas être la seule ou la plus équilibrée possible en termes de UT totaux par testeur, et des unités peuvent rester non attribuées si elles ne peuvent pas l\'être dans la limite.</em></p>';


            } else {
                const testersNeeded = Math.ceil(totalUtRequired / maxUtPerTesterPerDay);
                 resultsDiv.innerHTML += `<p class="warning">Attention : Cette tâche (${totalUtRequired.toFixed(2)} UT) dépasse la capacité d'une journée (${maxTotalUtPossible.toFixed(2)} UT) pour ${numTesters} testeur(s).</p>`;

                 if (averageUtPerTester > maxUtPerTesterPerDay + 1e-9) {
                      resultsDiv.innerHTML += `<p class="error">Chaque testeur devrait gérer environ ${averageUtPerTester.toFixed(2)} UT par jour si la tâche était réalisée sur plusieurs jours, ce qui dépasse la limite individuelle de ${maxUtPerTesterPerDay} UT par jour.</p>`;
                      resultsDiv.innerHTML += `<p class="warning">Estimation : Il faudrait au moins <span class="error">${testersNeeded} testeurs</span> pour réaliser cette tâche en une seule journée, ou la répartir sur plusieurs jours avec ${numTesters} testeur(s).</p>`;
                      assignmentResultsDiv.innerHTML = '<p class="info">La charge totale dépasse la capacité journalière. Une répartition détaillée pour une seule journée dans la limite de 6 UT par testeur n\'est pas possible telle quelle.</p>';

                 } else {
                       resultsDiv.innerHTML += `<p class="warning">Bien que la charge moyenne par testeur (${averageUtPerTester.toFixed(2)} UT) soit dans la limite individuelle de ${maxUtPerTesterPerDay} UT, la charge totale nécessite plus d\'une journée avec ${numTesters} testeur(s).</p>`;
                       resultsDiv.innerHTML += `<p class="warning">Estimation : La tâche prendra plus d\'une journée avec ${numTesters} testeur(s).</p>`;
                        assignmentResultsDiv.innerHTML = '<p class="info">La charge totale nécessite plus d\'une journée. Le tableau ci-dessous montre une distribution indicative de la <strong>charge totale de la tâche</strong> par testeur (sur plusieurs jours), basée sur une répartition proportionnelle des UT.</p>';
                 }


                 if (totalUtRequired > 0) {

                    let tableHtml = '<table>';
                    tableHtml += '<thead><tr><th>Testeur</th>';
                     uniqueIncludedCategories.forEach(catId => {
                         let headerText = catId.replace('_', ' ').toUpperCase();
                         if (catId.startsWith('r489_')) headerText = 'R489 ' + headerText.replace('R489 ', '');
                         else if (catId.startsWith('r485_')) headerText = 'R485 ' + headerText.replace('R485 ', '');
                         else if (catId.startsWith('r484_')) headerText = 'R484 ' + headerText.replace('R484 ', '');
                         else if (catId.startsWith('r486_')) headerText = 'R486 ' + headerText.replace('R486 ', '');
                         else if (catId.startsWith('r490_')) headerText = 'R490 ' + headerText.replace('R490 ', '');
                        tableHtml += `<th>${headerText} (approx.)</th>`;
                    });
                    tableHtml += '<th>Total UT de la Tâche (approx.)</th></tr></thead>';
                    tableHtml += '<tbody>';

                    const utPerTesterTotalTask = totalUtRequired / numTesters;

                    let utTotalAllCategories = 0;
                     for(const catId in quantities) {
                          if (uniqueIncludedCategories.includes(catId)) {
                             utTotalAllCategories += quantities[catId] * utValues[catId];
                          }
                     }


                    const utProportions = {};
                    uniqueIncludedCategories.forEach(catId => {
                         const utCategory = quantities[catId] * utValues[catId];
                         utProportions[catId] = (utTotalAllCategories > 1e-9) ? utCategory / utTotalAllCategories : 0;
                    });


                    let totalAssignedUt = 0;
                    const totalAssignedCategories = {};
                    uniqueIncludedCategories.forEach(catId => totalAssignedCategories[catId] = 0);


                    for (let i = 1; i <= numTesters; i++) {
                        tableHtml += '<tr>';
                        tableHtml += `<td>Testeur ${i}</td>`;

                        const testerUtLoad = utPerTesterTotalTask;

                        const testerUtLoadsByCategory = {};
                         const approxUnitsByCategory = {};
                         let testerTotalUtThisRow = 0;

                        uniqueIncludedCategories.forEach(catId => {
                             testerUtLoadsByCategory[catId] = testerUtLoad * utProportions[catId];
                             approxUnitsByCategory[catId] = (utValues[catId] > 1e-9) ? testerUtLoadsByCategory[catId] / utValues[catId] : 0;
                             testerTotalUtThisRow += testerUtLoadsByCategory[catId];

                             tableHtml += `<td>${approxUnitsByCategory[catId].toFixed(2)}</td>`;
                              totalAssignedCategories[catId] += approxUnitsByCategory[catId];
                        });


                        tableHtml += `<td>${testerTotalUtThisRow.toFixed(2)}</td>`;
                        totalAssignedUt += testerTotalUtThisRow;


                        tableHtml += '</tr>';
                    }

                    tableHtml += '<tfoot><tr><td><strong>Total</strong></td>';
                    uniqueIncludedCategories.forEach(catId => {
                         tableHtml += `<td><strong>${totalAssignedCategories[catId].toFixed(2)}</strong></td>`;
                    });
                    tableHtml += `<td><strong>${totalAssignedUt.toFixed(2)}</strong></td></tr></tfoot>`;


                    tableHtml += '</tbody>';
                    tableHtml += '</table>';
                     assignmentResultsDiv.innerHTML += tableHtml;
                    assignmentResultsDiv.innerHTML += '<p class="info"><em>Cette répartition montre une distribution indicative de la charge totale (potentiellement sur plusieurs jours) basée sur la proportion des UT totales. Les quantités d\'unités par catégorie sont approximatives.</em></p>';


                } else {
                     assignmentResultsDiv.innerHTML = '<p class="info">Aucune unité de test à répartir.</p>';
                }
            }

            isCalculating = false;
        }

        document.addEventListener('DOMContentLoaded', () => {
             rCodes.forEach(rCode => {
                 const checkbox = document.getElementById(`${rCode}Checkbox`);
                 if (checkbox) checkbox.checked = false;
                 handleRCodeToggle(rCode);
             });

             const numCategoryTypesSelect = document.getElementById('numCategoryTypesSelect');
             if (numCategoryTypesSelect) {
                 numCategoryTypesSelect.value = '3';
             }
        });

    </script>

</body>
</html>